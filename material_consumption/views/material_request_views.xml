<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Material Request List View -->
        <record id="view_material_request_list" model="ir.ui.view">
            <field name="name">material.request.list</field>
            <field name="model">material.request</field>
            <field name="arch" type="xml">
                <list string="Material Requests" decoration-info="state in ('draft', 'submitted')"
                      decoration-success="state in ('approved', 'issued')"
                      decoration-danger="state in ('rejected', 'cancelled')">
                     <field name="priority"/>
                    <field name="name"/>
                    <field name="request_date"/>
                    <field name="requested_by"/>
                    <field name="request_type"/>
                    <field name="current_approval_level"/>
                    <field name="required_approval_level"/>
                    <field name="project_id" optional="hide"/>
                    <field name="partner_id" optional="hide"/>
                    <field name="total_amount" widget="monetary"/>
                    <field name="state"/>

                </list>
            </field>
        </record>

        <!-- Material Request Form View -->
        <record id="view_material_request_form" model="ir.ui.view">
            <field name="name">material.request.form</field>
            <field name="model">material.request</field>
            <field name="arch" type="xml">
                <form string="Material Request">
                    <header>
                        <!-- Print Report -->
                        <button name="action_print_report"
                                type="object"
                                string="Print Report"
                                class="oe_highlight"
                                groups="material_consumption.group_material_user"/>
                        <!-- Submit -->
                        <button name="action_submit"
                                type="object"
                                string="Submit for Approval"
                                class="oe_highlight"
                                groups="material_consumption.group_material_user"
                                invisible="state != 'draft'"/>
                        <!-- Approve -->
                        <button name="action_approve"
                                type="object"
                                string="Approve"
                                class="oe_highlight"
                                groups="material_consumption.group_material_approver"
                                invisible="state != 'submitted' or not can_current_user_approve"/>
                        <!-- Reject -->
                        <button name="action_reject"
                                type="object"
                                string="Reject"
                                groups="material_consumption.group_material_approver"
                                invisible="state != 'submitted' or not can_current_user_approve"/>
                        <!-- Issue -->
                        <button name="action_issue_material"
                                type="object"
                                string="Issue Materials"
                                class="oe_highlight"
                                groups="material_consumption.group_material_issue_user"
                                invisible="state != 'approved'"/>
                        <!-- Cancel -->
                        <button name="action_cancel"
                                type="object"
                                string="Cancel"
                                invisible="state == 'issued'"/>
                        <!-- Reset -->
                        <button name="action_draft"
                                type="object"
                                string="Reset to Draft"
                                groups="material_consumption.group_material_manager"
                                invisible="state != 'cancelled' and state != 'rejected'"/>
                        <!-- Status -->
                        <field name="state"
                               widget="statusbar"
                               statusbar_visible="draft,submitted,approved,issued,rejected,cancelled"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_print_report"
                                    type="object"
                                    class="oe_stat_button"
                                    icon="fa-print"
                                    string="Print">
                            </button>
                            <button name="action_view_picking" type="object" class="oe_stat_button" icon="fa-truck"
                                    invisible="[('picking_id', '=', False)]">
                                <field name="picking_id" string="Stock Picking"/>
                            </button>
                        </div>
                        <div class="oe_title">
                            <h1>
                                <field name="priority" widget="priority" class="me-3"/>
                                <field name="name" readonly="1"/>
                            </h1>
                        </div>
                        <group readonly="state in ('approved', 'issued', 'rejected', 'cancelled')">
                            <group>
                                <field name="request_date"/>
                                <field name="requested_by" readonly="1"/>
                                <field name="picking_id" readonly="1"/>
                            </group>
                            <group>
                                <field name="request_type"/>
                                <field name="project_id" invisible="request_type != 'project'"
                                       required="request_type == 'project'"/>
<!--                                <field name="task_id" invisible="request_type != 'project'"-->
<!--                                       domain="[('project_id', '=', project_id)]"/>-->
                                <field name="dest_location_id" invisible="not project_id" required="request_type == 'project'" domain="[('project_id', '=', project_id)]"/>
                            </group>
                        </group>
                        <group string="Approval Progress" cols="4">
                            <group>
                                <field name="current_approval_level" string="Current Level" readonly="1"/>
                            </group>
                            <group>
                                <field name="required_approval_level" string="Required Level" readonly="1"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Materials">
                                <field name="line_ids">
                                    <list editable="bottom" readonly="parent.state in ('approved', 'issued', 'rejected', 'cancelled')">
                                        <control>
                                            <create name="add_product_control" string="Add a product"/>
                                        </control>
                                        <field name="sequence" widget="handle"/>
                                        <field name="product_id"/>
                                        <field name="location_id"/>
                                        <field name="lot_id" readonly="is_tracked == False"/>
                                        <field name="description" optional="hide"/>
                                        <field name="uom_id"/>
                                        <field name="available_qty" readonly="1"/>
                                        <field name="quantity"/>
                                        <field name="unit_price" column_invisible="parent.is_billable == False"/>
                                        <field name="subtotal" readonly="1"
                                               column_invisible="parent.is_billable == False"/>
                                    </list>
                                </field>
                                <group class="oe_subtotal_footer oe_right" invisible="[('is_billable', '=', False)]">
                                    <field name="total_amount" class="oe_subtotal_footer_separator" widget="monetary"/>
                                </group>
                            </page>
                            <page string="Notes">
                                <field name="notes" placeholder="Add internal notes here..." readonly="state in ('approved', 'issued', 'rejected', 'cancelled')"/>
                            </page>
                            <page string="Approval History">
                                <field name="approval_history_ids"/>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                </form>
            </field>
        </record>

        <!-- Material Request Kanban View -->
        <record id="view_material_request_kanban" model="ir.ui.view">
            <field name="name">material.request.kanban</field>
            <field name="model">material.request</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile">
                    <field name="name"/>
                    <field name="request_date"/>
                    <field name="requested_by"/>
                    <field name="total_amount"/>
                    <field name="state"/>
                    <templates>
                        <t t-name="card">
                            <div class="oe_kanban_global_click">
                                <div class="oe_kanban_details">
                                    <strong class="o_kanban_record_title">
                                        <span>
                                            <field name="name"/>
                                        </span>
                                    </strong>
                                    <div class="o_kanban_record_subtitle">
                                        <span>
                                            <field name="request_date"/>
                                        </span>
                                        <span>-</span>
                                        <span>
                                            <field name="requested_by"/>
                                        </span>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <span>Amount:
                                            <field name="total_amount" widget="monetary"/>
                                        </span>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="state" widget="label_selection"
                                               options="{'classes': {'draft': 'default', 'submitted': 'warning', 'approved': 'success', 'rejected': 'danger', 'issued': 'info', 'cancelled': 'muted'}}"/>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Material Request Search View -->
        <record id="view_material_request_search" model="ir.ui.view">
            <field name="name">material.request.search</field>
            <field name="model">material.request</field>
            <field name="arch" type="xml">
                <search string="Search Material Requests">
                    <field name="name" string="Reference" filter_domain="[('name', 'ilike', self)]"/>
                    <field name="requested_by"/>
                    <field name="project_id"/>
                    <field name="partner_id"/>
                    <filter name="draft" string="Draft" domain="[('state', '=', 'draft')]"/>
                    <filter name="submitted" string="Submitted" domain="[('state', '=', 'submitted')]"/>
                    <filter name="approved" string="Approved" domain="[('state', '=', 'approved')]"/>
                    <filter name="issued" string="Issued" domain="[('state', '=', 'issued')]"/>
                    <filter name="rejected" string="Rejected" domain="[('state', '=', 'rejected')]"/>
                    <filter name="my_requests" string="My Requests" domain="[('requested_by', '=', uid)]"/>
                    <group>
                        <filter name="group_by_state" string="State" context="{'group_by': 'state'}"/>
                        <filter name="group_by_request_type" string="Request Type"
                                context="{'group_by': 'request_type'}"/>
                        <filter name="group_by_requested_by" string="Requested By"
                                context="{'group_by': 'requested_by'}"/>
                        <filter name="group_by_date" string="Date" context="{'group_by': 'request_date'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Material Request Action -->
        <record id="action_material_request" model="ir.actions.act_window">
            <field name="name">Material Requests</field>
            <field name="res_model">material.request</field>
            <field name="view_mode">list,kanban,form</field>
            <field name="search_view_id" ref="view_material_request_search"/>
            <field name="context">{}</field>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to create a new material request.
                </p>
                <p>
                    Material requests allow you to request materials for projects or customers.
                </p>
            </field>
        </record>

        <!-- My Material Request Action -->
        <record id="action_my_material_request" model="ir.actions.act_window">
            <field name="name">My Material Requests</field>
            <field name="res_model">material.request</field>
            <field name="view_mode">list,kanban,form</field>
            <field name="search_view_id" ref="view_material_request_search"/>
            <field name="context">{}</field>
            <field name="domain">[('requested_by', '=', uid)]</field>
        </record>

        <!-- Pending Approvals Action -->
        <record id="action_pending_approvals" model="ir.actions.act_window">
            <field name="name">Pending Approvals</field>
            <field name="res_model">material.request</field>
            <field name="view_mode">list,kanban,form</field>
            <field name="search_view_id" ref="view_material_request_search"/>
            <field name="context">{}</field>
            <field name="domain">[('state', '=', 'submitted')]</field>
        </record>

        <!-- Material Request Report Action -->
        <record id="action_material_request_report" model="ir.actions.report">
            <field name="name">Print Material Request</field>
            <field name="model">material.request</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">material_consumption.material_request_draft_report</field>
            <field name="report_file">material_consumption/reports/material_request_report.xml</field>
            <field name="print_report_name">'Material Request - %s' % (object.name)</field>
        </record>
    </data>
</odoo>
